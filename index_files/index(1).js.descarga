(function(){"use strict";try{if(typeof document<"u"){var t=document.createElement("style");t.appendChild(document.createTextNode(":root{--animation-duration: 1.2s;--slide-offset: 300px;--slide-offset-minus: var(--slide-offset-minus)}.asklayer-widget{box-sizing:border-box;font-family:sans-serif;z-index:2147483647;border:none;position:fixed;margin:0;padding:0;width:370px;height:0}.asklayer-widget.al-hidden{opacity:0!important;pointer-events:none!important;height:0!important}.post-purchase.al-hidden{position:fixed!important}#asklayer-widget.slide-in-top{animation:slide-in-top var(--animation-duration);animation-fill-mode:forwards}.asklayer-widget.slide-in-bottom{animation:slide-in-bottom var(--animation-duration);animation-fill-mode:forwards}.asklayer-widget.slide-out-top{animation:slide-out-top var(--animation-duration);animation-fill-mode:forwards}.asklayer-widget.slide-out-bottom{animation:slide-out-bottom var(--animation-duration);animation-fill-mode:forwards}@keyframes slide-in-top{0%{opacity:0;transform:translateY(var(--slide-offset-minus))}to{opacity:1;transform:translateY(0)}}@keyframes slide-in-bottom{0%{opacity:0;transform:translateY(var(--slide-offset))}to{opacity:1;transform:translateY(0)}}@keyframes slide-out-top{0%{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(var(--slide-offset-minus))}}@keyframes slide-out-bottom{0%{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(var(--slide-offset))}}.unavailable{font-family:SF Pro JP,SF Pro Text,SF Pro Icons,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,メイリオ,Meiryo,ＭＳ Ｐゴシック,Helvetica Neue,Helvetica,Arial,sans-serif;background:#fff;padding:18px;box-shadow:10px 10px 20px #0000001a;border-radius:10px;border:3px solid #01a3a4;margin:0 12px}.asklayer-widget-screen-center{position:relative;margin:24px 0}.asklayer-overlay-wrapper{position:fixed;display:block;width:100vw;height:100vh;top:0;left:0;right:0;bottom:0;background-color:#00000040;min-height:100vh;overflow-y:auto;display:grid;place-items:center;z-index:2147483646}@supports (height: 100dvh){.asklayer-overlay-wrapper{height:100dvh;min-height:100dvh}}.asklayer-overlay-wrapper.al-hidden{opacity:0!important;pointer-events:none!important;height:0!important;min-height:0!important}.asklayer-body-overflow-hidden{overflow:hidden}")),document.head.appendChild(t)}}catch(i){console.error("vite-plugin-css-injected-by-js",i)}})();
var V=Object.defineProperty;var $=(n,e,t)=>e in n?V(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var o=(n,e,t)=>($(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();var d=(n=>(n.ASKKLAYER_SESSION="asklayer_session",n.ASKLAYER_SEARCH="asklayer_search",n.ASKLAYER_REFERRER="asklayer_referrer",n.ASKLAYER_LANDING_PAGE="asklayer_landing_page",n.ASKLAYER_ACCESS_HISTORY="asklayer_access_history",n.ASKLAYER_BROWSING_HISTORY="asklayer_browsing_history",n.ASKLAYER_NUMBER_OF_PAGEVIEWS_IN_SESSION="asklayer_number_of_pageviews_in_session",n.ASKLAYER_SURVEY_SHOWN="asklayer_survey_shown",n.ASKLAYER_SURVEY_COMPLETED="asklayer_survey_completed",n.ASKLAYER_NANOID="asklayer_nanoid",n))(d||{});class K{constructor(){o(this,"type","localStorage");typeof localStorage>"u"&&(this.type="cookie")}set(e,t,r=!1){typeof t=="object"&&(t=JSON.stringify(t)),this.type==="localStorage"&&(localStorage.setItem(e,t),r&&localStorage.setItem(`${e}_expires`,this.toUnixTimestamp(r).toString()))}setSession(e,t){typeof t=="object"&&(t=JSON.stringify(t)),sessionStorage.setItem(e,t)}get(e){if(this.type==="localStorage"){const t=localStorage.getItem(e);return t===null||this.isExpired(e)?null:this.tryJsonParse(t)}}getSession(e){const t=sessionStorage.getItem(e);return this.tryJsonParse(t)}hasKeyStartsWith(e){return Object.keys(localStorage).some(t=>t.startsWith(e))}isExpired(e){const t=localStorage.getItem(`${e}_expires`);return t?parseInt(t)<Date.now():!1}tryJsonParse(e){try{return JSON.parse(e)}catch{return e}}toUnixTimestamp(e){return Date.now()+Math.floor(e*24*60*60*1e3)}}const u=new K;function H(){const n=u.get(d.ASKLAYER_ACCESS_HISTORY);return n&&Array.isArray(n)&&n.length>0?n:!1}function F(){let n=H();n||(n=[]),n.push(Date.now()),u.set(d.ASKLAYER_ACCESS_HISTORY,n)}function B(){let n=u.get(d.ASKLAYER_BROWSING_HISTORY);n||(n=[]),n.length>500&&n.shift(),n.push([location.href,Date.now()]),u.set(d.ASKLAYER_BROWSING_HISTORY,n)}function q(){let n=+u.getSession(d.ASKLAYER_NUMBER_OF_PAGEVIEWS_IN_SESSION);u.setSession(d.ASKLAYER_NUMBER_OF_PAGEVIEWS_IN_SESSION,++n)}const A=(n,e,t=!1)=>{const r=u.get(e)??[],s=r.find(l=>l.id===n);if(s?s.history.push(Date.now()):r.push({id:n,history:[Date.now()]}),u.set(e,r),!t)return;const i=u.getSession(e)??[],a=i.find(l=>l.id===n);a?a.history.push(Date.now()):i.push({id:n,history:[Date.now()]}),u.setSession(e,i)},j=()=>{const n=document.documentElement,e=document.body,t=n.scrollTop?n.scrollTop:e.scrollTop,r=(n.scrollTop?n.scrollHeight:e.scrollHeight)-n.clientHeight;return Math.round(t/r*100)},z=()=>!!document.querySelector(".osChatOptimize .panel.fixed");var c=(n=>(n.FORCE_TRIGGERED="FORCE_TRIGGERED",n.TIME_ELAPSED="TIME_ELAPSED",n.NO_OPERATION_TIME_ELAPSED="NO_OPERATION_TIME_ELAPSED",n.WINDOW_SCROLL="WINDOW_SCROLL",n.WINDOW_CLICK="WINDOW_CLICK",n.SURVEY_OPENED="SURVEY_OPENED",n.SURVEY_CLOSED="SURVEY_CLOSED",n.SURVEY_READY="SURVEY_READY",n.SURVEY_COMPLETED="SURVEY_COMPLETED",n.SURVEY_HEIGHT_CHANGED="SURVEY_HEIGHT_CHANGED",n.SESSION_CREATED="SESSION_CREATED",n.EVENT_GENERATOR_CREATED="EVENT_GENERATOR_CREATED",n.QUERY_STATUS="QUERY_STATUS",n.COUPON_APPLICATION="COUPON_APPLICATION",n.SURVEY_EXIT_INTENT="SURVEY_EXIT_INTENT",n.SUBMISSION_ID="SUBMISSION_ID",n))(c||{});class J{constructor(){o(this,"observers");o(this,"iframe");this.observers=[]}addObserver(e){this.observers.push(e)}removeObserver(e){this.observers=this.observers.filter(t=>t!==e)}notify(e){this.observers.forEach(t=>t.update(e))}}const X=new URL("https://renderer.asklayer.io/index.html").origin;class Q extends J{constructor(){super();o(this,"timeElapsed",0);o(this,"noOperationTimeElapsed",0)}generateEvent(t){this.notify(t)}init(){this.tick(),this.listenEvents(),this.listenMessageFromChild(),this.startSession(),B(),q(),this.generateEvent({type:c.EVENT_GENERATOR_CREATED,value:null})}startSession(){return this.sessionExists()||(this.setSessionVariables(),F(),this.generateEvent({type:c.SESSION_CREATED,value:null})),!0}sessionExists(){return!!u.getSession(d.ASKKLAYER_SESSION)}setSessionVariables(){u.setSession(d.ASKKLAYER_SESSION,Date.now()),u.setSession(d.ASKLAYER_SEARCH,location.search),u.setSession(d.ASKLAYER_REFERRER,document.referrer),u.setSession(d.ASKLAYER_LANDING_PAGE,location.href)}resetNoOperationTime(){this.noOperationTimeElapsed=0}tick(){setInterval(()=>{this.timeElapsed+=1,this.noOperationTimeElapsed+=1,this.generateEvent({type:c.TIME_ELAPSED,value:this.timeElapsed}),this.generateEvent({type:c.NO_OPERATION_TIME_ELAPSED,value:this.noOperationTimeElapsed})},1e3)}triggerSurvey(t){this.generateEvent({type:c.FORCE_TRIGGERED,surveyId:t})}getStatus(t){this.generateEvent({type:c.QUERY_STATUS,surveyId:t})}listenEvents(){const t=["scroll","click","blur","mousemove","keydown","touchstart","touchmove","touchend","resize"],r=["asklayer-close"];[...t,...r].forEach(s=>{window.addEventListener(s,i=>{var a;if(this.resetNoOperationTime(),i.type==="blur"){if(((a=document.activeElement)==null?void 0:a.tagName)==="IFRAME"||i.target!==window||z())return;this.generateEvent({type:c.SURVEY_EXIT_INTENT,value:null})}i.type==="scroll"?this.generateEvent({type:c.WINDOW_SCROLL,value:j()}):i.type==="asklayer-close"&&this.generateEvent({type:c.SURVEY_CLOSED,value:null})})}),document.body.addEventListener("mouseleave",s=>{s.clientY<20&&this.generateEvent({type:c.SURVEY_EXIT_INTENT,value:null})})}listenMessageFromChild(){window.addEventListener("message",t=>{if(t.origin!==X)return;const{type:r,value:s,surveyId:i}=t.data;switch(r){case"ASKLAYER_HEIGHT_CHANGED":this.generateEvent({type:c.SURVEY_HEIGHT_CHANGED,value:s,surveyId:i});break;case"ASKLAYER_READY":this.generateEvent({type:c.SURVEY_READY,value:s,surveyId:i});break;case"ASKLAYER_CLOSED":this.generateEvent({type:c.SURVEY_CLOSED,value:s,surveyId:i});break;case"ASKLAYER_COMPLETED":this.generateEvent({type:c.SURVEY_COMPLETED,value:s,surveyId:i});break;case"ASKLAYER_SUBMISSION_ID":this.generateEvent({type:c.SUBMISSION_ID,value:s,surveyId:i});break;case"ASKLAYER_COUPON_APPLICATION":this.generateEvent({type:c.COUPON_APPLICATION,value:s,surveyId:i});break}},!1)}}var h=(n=>(n.WIDGET="WIDGET",n.POST_PURCHASE="POST_PURCHASE",n.LINK="LINK",n))(h||{});let Z=(n=21)=>crypto.getRandomValues(new Uint8Array(n)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");class v{constructor(){o(this,"platform","generic");o(this,"platformId","");o(this,"orderId","")}isLoggedIn(){return!!this.getPlatformId()}getPlatformId(){return this.platformId||this.setPlatformId(),this.platformId}setPlatformId(){var e;this.platformId=((e=window.asklayerData)==null?void 0:e.platformId)??""}getOrderId(){return this.orderId||this.setOrderId(),this.orderId}getCurrentPageId(){return""}getCurrentProductId(){return""}setOrderId(){var e;this.orderId=((e=window.asklayerData)==null?void 0:e.orderId)??""}async getCartState(){return[]}getPostPurchaseStyle(){return{}}getPostPurchaseWrapper(){return null}async getUserTags(e){return e?[]:[]}}class ee extends v{constructor(){super(...arguments);o(this,"platform","shopify")}setPlatformId(){var t,r,s,i;(t=window.Shopify)!=null&&t.checkout?this.platformId=window.Shopify.checkout.customer_id??"":this.platformId=((i=(s=(r=window.ShopifyAnalytics)==null?void 0:r.meta)==null?void 0:s.page)==null?void 0:i.customerId)??""}setOrderId(){var t,r;this.orderId=((r=(t=window.Shopify)==null?void 0:t.checkout)==null?void 0:r.order_id)??""}getCurrentPageId(){var r,s,i,a,l;return((i=(s=(r=window.ShopifyAnalytics)==null?void 0:r.meta)==null?void 0:s.page)==null?void 0:i.resourceType)==="page"?((l=(a=window.ShopifyAnalytics)==null?void 0:a.meta)==null?void 0:l.page.resourceId.toString())??"":""}getCurrentProductId(){var r,s,i,a,l;return((i=(s=(r=window.ShopifyAnalytics)==null?void 0:r.meta)==null?void 0:s.page)==null?void 0:i.resourceType)==="product"?((l=(a=window.ShopifyAnalytics)==null?void 0:a.meta)==null?void 0:l.page.resourceId.toString())??"":""}async getCartState(){return[]}getPostPurchaseStyle(){return{width:"100%",height:"0",position:"relative",padding:"0"}}async getOrder(t){const r=this.getOrderId();if(!r)return[];try{const i=await fetch("https://asklayer-generic-api-6nonizu4oa-an.a.run.app/asklayer/order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:r,userId:t,platform:"shopify"})});if(i.ok)return await i.json();throw new Error(i.statusText)}catch{return[]}}async getUserTags(t){var s,i,a,l,g;const r=((a=(i=(s=window.ShopifyAnalytics)==null?void 0:s.meta)==null?void 0:i.page)==null?void 0:a.customerId)||((g=(l=window.Shopify)==null?void 0:l.checkout)==null?void 0:g.customer_id);if(!r)return[];try{const f=await fetch("https://asklayer-generic-api-6nonizu4oa-an.a.run.app/asklayer/customer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t,query:"tag",customerId:r,platform:"shopify"})});if(f.ok)return await f.json();throw new Error(f.statusText)}catch{return[]}}getPostPurchaseWrapper(){const t=document.querySelector("div.section__content");if(t)return t;const r=document.querySelector(".thank-you__additional-content");if(r){const s=document.createElement("div");return s.style.paddingTop="25px",r.append(s),s}return document.body}}class te extends v{constructor(){super(...arguments);o(this,"platform","wix")}async getMember(){const t=location.hostname,r="wix_app_id_placeholder";try{const s=await fetch(`https://${t}/_api/apps/current-member/${r}`);if(s.ok)return(await s.json()).member}catch(s){console.error(s)}return null}isLoggedIn(){return!!this.platformId}async getCartState(){return[]}}class se extends v{constructor(){super(...arguments);o(this,"platform","wordpress")}isLoggedIn(){return!!this.platformId}async getCartState(){return[]}}class re extends v{constructor(){super(...arguments);o(this,"platform","generic")}}function E(n){switch(n){case"shopify":return new ee;case"wix":return new te;case"wordpress":return new se;default:return new re}}function _(){return typeof window.Shopify<"u"?E("shopify"):typeof window.wixEmbedsAPI<"u"?E("wix"):typeof window.wp<"u"?E("wordpress"):E("generic")}class ne{constructor(e,t){o(this,"iframeElement");o(this,"channel");o(this,"surveyData");o(this,"platform");o(this,"postPurchase");o(this,"widgetOffsetX",15);o(this,"widgetOffsetY",15);o(this,"widgetBaseWidth",370);o(this,"sendPostMessage",(e,t=null)=>{this.iframeElement.contentWindow.postMessage({type:e,value:t},"*")});this.surveyData=e,this.channel=t,this.platform=_(),this.iframeElement=this.createIframe(),this.appendIframe()}getAnimationClass(){switch(this.channel.type){case h.WIDGET:return"slide-in-bottom";case h.POST_PURCHASE:return"";default:return""}}show(){var t,r;this.sendShowEvent();const e=this.getAnimationClass();e&&this.iframeElement.classList.add(e),this.isScreenCenterPosition()&&((r=(t=this.channel.wrapperElement)==null?void 0:t.classList)==null||r.remove("al-hidden"),document.body.classList.add("asklayer-body-overflow-hidden")),this.iframeElement.classList.remove("al-hidden")}close(){this.iframeElement.classList.remove("slide-in-bottom"),this.iframeElement.classList.add("slide-out-bottom"),setTimeout(()=>{var e,t;this.iframeElement.classList.add("al-hidden"),this.iframeElement.classList.remove("slide-out-bottom"),this.isScreenCenterPosition()&&((t=(e=this.channel.wrapperElement)==null?void 0:e.classList)==null||t.add("al-hidden"),document.body.classList.remove("asklayer-body-overflow-hidden"))},1e3)}changeHeight(e){this.iframeElement.style.height=`${e}px`}getIframeSrc(){return`https://renderer.asklayer.io/index.html?surveyid=${this.surveyData.id}`}appendIframe(){const e=this.channel.wrapperElement||document.body;this.channel.type===h.POST_PURCHASE?e.prepend(this.iframeElement):e.appendChild(this.iframeElement)}createIframe(){const e=document.createElement("iframe");return e.dataset.suveryId=this.surveyData.id,e.src=this.getIframeSrc(),e.allow="clipboard-write;",this.setStyleByChannelType(e,this.channel.type),e}setStyleByChannelType(e,t){if(t===h.POST_PURCHASE){e.classList.add("asklayer-widget","post-purchase","al-hidden");const r=this.platform.getPostPurchaseStyle();Object.assign(e.style,r)}else if(t===h.LINK){e.classList.add("asklayer-widget","al-hidden");const r=this.getWidgetPosition(this.surveyData.position);Object.assign(e.style,r)}else{const r=["asklayer-widget","al-hidden"];let s={};CSS.supports("max-height","100dvh")?s={maxHeight:"calc(100dvh - 30px)"}:s={maxHeight:"80vh"},this.isScreenCenterPosition()&&(r.push("asklayer-widget-screen-center"),s=null),e.classList.add(...r);const i=this.getWidgetPosition(this.surveyData.position);Object.assign(e.style,i,s)}}createSurveyRenderer(){this.sendNanoid(),this.sendURL(),this.sendPlatformVariables().catch(e=>console.error(e)),this.sendSurveyData()}getWidgetPosition(e="left"){let t;if(window.innerWidth<=500&&e!=="screen-center"){const r=Math.min(Math.round(window.innerWidth*.95),370);t={width:`${r}px`,bottom:`${this.widgetOffsetY}px`,left:`calc(50% - ${r/2}px)`}}else switch(e){case"left":t={bottom:`${this.widgetOffsetY}px`,left:`${this.widgetOffsetX}px`};break;case"right":t={bottom:`${this.widgetOffsetY}px`,right:`${this.widgetOffsetX}px`};break;case"center":t={bottom:`${this.widgetOffsetY}px`,left:`calc(50% - ${this.widgetBaseWidth/2}px)`};break}return t}sendSurveyData(){this.surveyData,this.sendPostMessage("SEND_SURVEY_DATA",{...this.surveyData})}sendNanoid(){const e=this.getNanoId();this.sendPostMessage("SEND_NANOID",e)}sendURL(){this.sendPostMessage("SEND_URL",location.href)}sendShowEvent(){this.sendPostMessage("SEND_SHOW_EVENT",this.surveyData.id)}async sendPlatformVariables(){let e="",t="";if(this.channel.type===h.LINK){const l=new URLSearchParams(location.search);e=l.get("platformId")??"",t=l.get("orderId")??""}else e=this.platform.getPlatformId(),t=this.platform.getOrderId();const s=`asklayer_submission_${this.surveyData.id}`,i=u.get(s),a={id:e,orderId:t,channelType:this.channel.type,language:this.detectLanguage(),submissionId:i==null?void 0:i.submissionId};this.sendPostMessage("SEND_PLATFORM_VARIABLES",a)}detectLanguage(){const e=new URLSearchParams(window.location.search),t=e.get("lang")||e.get("language");let r=t;return t||(r=navigator.language),r.slice(0,2)}sendAnalyticsData(){var s;const e=document.referrer,r=new URLSearchParams(location.search).get("utm")??"";(s=this.iframeElement.contentWindow)==null||s.postMessage({type:"SEND_ANALYTICS_VALUES",value:{referrer:e,utm:r}},"https://renderer.asklayer.io/index.html")}getNanoId(){const e=u.get(d.ASKLAYER_NANOID);if(e)return e;{const t=Z();return u.set(d.ASKLAYER_NANOID,t),t}}isScreenCenterPosition(){return this.surveyData.position==="screen-center"&&this.channel.wrapperElement&&this.channel.type===h.WIDGET}}class R{constructor(e){o(this,"triggerSettings");o(this,"enabledTriggers");o(this,"triggerType");o(this,"triggered",!1);this.triggerSettings=e,this.enabledTriggers=e.enabledTriggers??{},this.triggerType=e.triggerType}isEnabledAdvancedTrigger(e){return this.triggerType==="advanced"&&this.enabledTriggers[e]}setTriggered(e){this.triggered=e}checkTrigger(e){if(this.triggered)return!1;switch(e.type){case c.TIME_ELAPSED:return this.triggerType==="immediately"?e.value>=0:this.triggerType==="standard"?e.value>=10:this.isEnabledAdvancedTrigger("timeElapsed")?e.value>=+this.triggerSettings.timeElapsed:!1;case c.NO_OPERATION_TIME_ELAPSED:return this.isEnabledAdvancedTrigger("idleTimeElapsed")?e.value>=+this.triggerSettings.idleTimeElapsed:!1;case c.WINDOW_SCROLL:return this.isEnabledAdvancedTrigger("scrollPercent")?e.value>=+this.triggerSettings.scrollPercent:!1;case c.SURVEY_EXIT_INTENT:return this.triggerType==="onExitIntent";default:return!1}}getEnabledTriggers(){const e=[];if(this.triggerType==="immediately")e.push("immediately");else if(this.triggerType==="standard")e.push("10 seconds");else if(this.triggerType==="advanced")this.isEnabledAdvancedTrigger("timeElapsed")&&e.push(`${this.triggerSettings.timeElapsed} seconds`),this.isEnabledAdvancedTrigger("idleTimeElapsed")&&e.push(`${this.triggerSettings.idleTimeElapsed} seconds of inactivity`),this.isEnabledAdvancedTrigger("scrollPercent")&&e.push(`${this.triggerSettings.scrollPercent}% scroll`);else throw new Error(`Unknown trigger type ${this.triggerType}`);return e}}class ie{constructor(){o(this,"observables",new Map)}subscribe(e){e.addObserver(this),this.observables.set(e.constructor.name,e)}}class ae extends ie{constructor(t,r,s){super();o(this,"surveyState",{current:"INITIAL"});o(this,"gateState",{current:"INITIAL"});o(this,"surveyData");o(this,"location");o(this,"gate");o(this,"trigger");o(this,"iframe");o(this,"channel");this.surveyData=t,this.gate=r,this.channel=s,this.setTrigger(s),this.createProxy()}init(){this.setIframe()}setTrigger(t){t.type===h.WIDGET?this.trigger=new R(this.surveyData.delivery.siteWidget.trigger):this.trigger=new R({triggerType:"immediately"})}setIframe(){const t=this.surveyData.position==="screen-center",r=this.channel.type===h.WIDGET;if(t&&r){const s=document.createElement("div");s.id="asklayer-wrapper-div",s.classList.add("asklayer-overlay-wrapper"),s.classList.add("al-hidden"),document.body.appendChild(s),this.channel.wrapperElement=s}this.iframe=new ne(this.surveyData,this.channel)}onSurveyStateChanged(t,r){switch(t){case"STARTED":this.init();break;case"READY":this.iframe.createSurveyRenderer();break;case"VISIBLE":A(this.surveyData.id,d.ASKLAYER_SURVEY_SHOWN,!0),this.iframe.show();break;case"HIDDEN":this.iframe.close();break;case"COMPLETED":A(this.surveyData.id,d.ASKLAYER_SURVEY_COMPLETED);break}}async update(t){const r=t.type,s=t.surveyId;if(!(s&&s!==this.surveyData.id))switch(r){case c.EVENT_GENERATOR_CREATED:this.surveyState.current="STARTED";break;case c.FORCE_TRIGGERED:this.surveyState.current="VISIBLE";break;case c.QUERY_STATUS:this.showStatus();break;case c.TIME_ELAPSED:case c.NO_OPERATION_TIME_ELAPSED:case c.WINDOW_SCROLL:case c.SURVEY_EXIT_INTENT:await this.examine(t)&&(this.surveyState.current="VISIBLE");break;case c.SURVEY_READY:this.surveyState.current="READY";break;case c.SURVEY_CLOSED:this.surveyState.current="HIDDEN";break;case c.SURVEY_COMPLETED:this.surveyState.current="COMPLETED";break;case c.SURVEY_HEIGHT_CHANGED:this.iframe.changeHeight(t.value);break;case c.COUPON_APPLICATION:this.applyCoupon(t.value);break;case c.SUBMISSION_ID:u.set(`asklayer_submission_${s}`,{submissionId:t.value,timestamp:Date.now()});break}}async examine(t){return this.shouldEmit(t)&&await this.doesPassGates()}async doesPassGates(){if(this.gateState.current==="PASSED")return!0;if(this.gateState.current==="FAILED")return!1;const t=await this.gate.checkGates();return t?this.gateState.current="PASSED":this.gateState.current="FAILED",t}showStatus(){console.info({status:this.surveyState.current,failedGates:this.gate.getFailedGates(),triggers:this.trigger.getEnabledTriggers()})}shouldEmit(t){if(this.surveyState.current==="INITIAL"||this.trigger.triggered)return!1;const r=this.trigger.checkTrigger(t);return r&&this.trigger.setTriggered(!0),r}createProxy(){this.surveyState=new Proxy(this.surveyState,{get:(t,r)=>t[r],set:(t,r,s)=>(t[r]!==s&&this.onSurveyStateChanged(s,t[r]),t[r]=s,!0)})}applyCoupon(t){typeof window.Shopify=="object"&&fetch(`/discount/${t}`).then(()=>{}).catch(r=>{})}}const I="https://surveydatacdn.asklayer.io",G="https://surveydata.asklayer.io",oe="https://geoip.peakdigital.cloud",m=async n=>{try{const e=await fetch(n);if(e.ok)return await e.json();throw new Error("Failed to fetch")}catch(e){throw new Error(e)}},le=async n=>{const e=n.targetSurvey,t=n.targetWorkspace;if(!e||!t)return[null,new Error("Survey id or workspace id is not provided")];try{return[(await m(`${I}/workspace/${t}/survey/${e}`)).surveys,null]}catch{try{return[(await m(`${G}/workspace/${t}/survey/${e}`)).surveys,null]}catch{return[null,new Error("Failed to fetch")]}}},ce=async n=>{let e;n.targetWorkspace?e=`${I}/workspace/${n.targetWorkspace}`:n.targetUser&&(e=`${I}/user/${n.targetUser}`);let t=null;try{t=(await m(e)).surveys}catch{try{const s=e.replace(I,G);t=(await m(s)).surveys}catch{return[null,new Error("Failed to fetch")]}}return n.type===h.POST_PURCHASE?t=t.filter(r=>r.delivery.enabledDeliveryTypes.postPurchase):n.type===h.WIDGET&&(t=t.filter(r=>r.delivery.enabledDeliveryTypes.siteWidget)),[t,null]},ue=async()=>{try{return await m(oe)}catch(n){return console.error(n),null}};function de(n,e){const t=n==null?void 0:n.dataset.workspace,r=n==null?void 0:n.dataset.pluid;if(!t&&!r)throw new Error("Workspace id is not provided");const s=n==null?void 0:n.dataset.surveyid,i=(n==null?void 0:n.dataset.channel)??h.WIDGET;return i===h.LINK?{type:i,targetWorkspace:t,targetUser:r,targetSurvey:s}:i===h.POST_PURCHASE?{type:i,targetWorkspace:t,targetUser:r,wrapperElement:e.getPostPurchaseWrapper()}:{type:i,targetWorkspace:t,targetUser:r,wrapperElement:null}}const ge=n=>{const e=u.get(d.ASKLAYER_SURVEY_COMPLETED);return Array.isArray(e)?e.map(t=>t.id).includes(n):!1},he=()=>{const t=navigator.language.toLowerCase().startsWith("ja")?`
      <div class="unavailable">
        <p><strong>このアンケートは利用できません。</strong></p>
        <p>考えられる理由は次のとおりです：</p>
        <ul>
          <li>このアンケートが公開されていません。</li>
          <li>アンケートの実施者がリンク機能を有効にしていません。</li>
          <li>アンケートの実施者のアカウント制限を超過しました。</li>
        </ul>
      </div>
    `:`
      <div class="unavailable">
        <p><strong>This survey is unavailable.</strong></p>
        <p>Possible reasons include:</p>
        <ul>
          <li>The survey is not published.</li>
          <li>The survey owner has not enabled link functionality.</li>
          <li>The survey owner has exceeded their account limit.</li>
        </ul>
      </div>
    `,r=document.createElement("div");r.innerHTML=t,document.body.appendChild(r)},pe=()=>{const t=navigator.language.toLowerCase().startsWith("ja")?`
      <div class="unavailable">
        <p><strong>このアンケートは回答済みです。</strong></p>
      </div>
    `:`
      <div class="unavailable">
        <p><strong>You have already completed this survey.</strong></p>
      </div>
    `,r=document.createElement("div");r.innerHTML=t,document.body.appendChild(r)};var T=/iPhone/i,O=/iPod/i,P=/iPad/i,L=/\biOS-universal(?:.+)Mac\b/i,b=/\bAndroid(?:.+)Mobile\b/i,D=/Android/i,S=/(?:SD4930UR|\bSilk(?:.+)Mobile\b)/i,w=/Silk/i,y=/Windows Phone/i,k=/\bWindows(?:.+)ARM\b/i,C=/BlackBerry/i,N=/BB10/i,U=/Opera Mini/i,M=/\b(CriOS|Chrome)(?:.+)Mobile/i,Y=/Mobile(?:.+)Firefox\b/i,W=function(n){return typeof n<"u"&&n.platform==="MacIntel"&&typeof n.maxTouchPoints=="number"&&n.maxTouchPoints>1&&typeof MSStream>"u"};function fe(n){return function(e){return e.test(n)}}function ye(n){var e={userAgent:"",platform:"",maxTouchPoints:0};!n&&typeof navigator<"u"?e={userAgent:navigator.userAgent,platform:navigator.platform,maxTouchPoints:navigator.maxTouchPoints||0}:typeof n=="string"?e.userAgent=n:n&&n.userAgent&&(e={userAgent:n.userAgent,platform:n.platform,maxTouchPoints:n.maxTouchPoints||0});var t=e.userAgent,r=t.split("[FBAN");typeof r[1]<"u"&&(t=r[0]),r=t.split("Twitter"),typeof r[1]<"u"&&(t=r[0]);var s=fe(t),i={apple:{phone:s(T)&&!s(y),ipod:s(O),tablet:!s(T)&&(s(P)||W(e))&&!s(y),universal:s(L),device:(s(T)||s(O)||s(P)||s(L)||W(e))&&!s(y)},amazon:{phone:s(S),tablet:!s(S)&&s(w),device:s(S)||s(w)},android:{phone:!s(y)&&s(S)||!s(y)&&s(b),tablet:!s(y)&&!s(S)&&!s(b)&&(s(w)||s(D)),device:!s(y)&&(s(S)||s(w)||s(b)||s(D))||s(/\bokhttp\b/i)},windows:{phone:s(y),tablet:s(k),device:s(y)||s(k)},other:{blackberry:s(C),blackberry10:s(N),opera:s(U),firefox:s(Y),chrome:s(M),device:s(C)||s(N)||s(U)||s(Y)||s(M)},any:!1,phone:!1,tablet:!1};return i.any=i.apple.device||i.android.device||i.windows.device||i.other.device,i.phone=i.apple.phone||i.android.phone||i.windows.phone,i.tablet=i.apple.tablet||i.android.tablet||i.windows.tablet,i}const x=()=>ye(window.navigator).phone,Se=(n,e="millisecond")=>{if(e==="millisecond"){let[t,r]=n.split(/(?=[a-z])/);return t=parseInt(t),r==="s"?t*1e3:r==="m"?t*60*1e3:r==="h"?t*60*60*1e3:r==="d"?t*24*60*60*1e3:0}else if(e==="day"){let[t,r]=n.split(/(?=[a-z])/);return t=parseInt(t),r==="s"?t/(24*60*60):r==="m"?t/(24*60):r==="h"?t/24:r==="d"?t:3650}},me=n=>{const e=H();if(e){if(!n||n==="any")return e.length;{const t=Se(n),r=Date.now()-t;let s=0;for(;e.pop()>=r;)s++;return s}}else return 0},Ee=n=>{var e;if(n.type==="spin-to-win")return n.wheelSegments.slice(0,+n.wheelSegmentCount).some(r=>{var s;return((s=r.coupon)==null?void 0:s.couponType)==="pool"&&r.coupon.pool});if(n.showForm){const t=n.thankYouContents.find(r=>r.type==="coupon");return t&&((e=t.coupon)==null?void 0:e.couponType)==="pool"&&(!t.hidden||t.sendCouponByMail)}else return!1};class we{constructor(e,t){o(this,"survey",null);o(this,"location",null);o(this,"settings",null);o(this,"enabled",null);o(this,"platform",null);o(this,"testMode",!1);o(this,"recurrenceOff",{}.VITE_GATE_RECURRENCE_CHECK_OFF==="true");o(this,"channel",null);o(this,"failedGates",[]);this.survey=e,this.channel=t,t.type===h.WIDGET?this.settings=e.delivery.siteWidget:t.type===h.POST_PURCHASE?(this.settings=e.delivery.postPurchase,this.settings.recurrence={recurrenceType:"every_time_not_completed"}):this.settings=null,this.platform=_()}async checkGates(){if(this.channel.type===h.LINK||this.testMode)return!0;if(this.enabled!==null)return this.enabled;const e=new Map([["recurrence",this.recurrence.bind(this)],["url",this.isVisibleOnUrl.bind(this)],["lang",this.lang.bind(this)],["referrer",this.referrer.bind(this)],["device",this.device.bind(this)],["frequency",this.frequency.bind(this)],["numberOfPageViewsInSession",this.numberOfPageViewsInSession.bind(this)],["browsingHistory",this.browsingHistory.bind(this)],["blockIP",this.blockIP.bind(this)]]);for(const[s,i]of e.entries()){if(this.recurrenceOff&&s==="recurrence")continue;if(!i())return this.failedGates.push(s),this.enabled=!1}const t=new Map([["userTags",this.userTags.bind(this)],["loginState",this.loginState.bind(this)],["geoLocation",this.geolocation.bind(this)],["productsOrdered",this.productsOrdered.bind(this)]]);return(await Promise.all(Array.from(t.values()).map(s=>s()))).forEach((s,i)=>{if(!s){const a=Array.from(t.keys())[i];this.failedGates.push(a),this.enabled=!1}}),this.enabled===!1?!1:this.enabled=!0}getFailedGates(){return this.failedGates}doesMatch(e,t,r){let s=!1;switch(e){case"equals":r.replace(/\?.*$/,"").replace(/\/$/,"")===t.replace(/\?.*$/,"").replace(/\/$/,"")&&(s=!0);break;case"startsWith":r.replace(/\?.*$/,"").replace(/\/$/,"").startsWith(t.replace(/\?.*$/,"").replace(/\/$/,""))&&(s=!0);break;case"endsWith":r.replace(/\?.*$/,"").replace(/\/$/,"").endsWith(t.replace(/\?.*$/,"").replace(/\/$/,""))&&(s=!0);break;case"contains":r.toLowerCase().includes(t.toLowerCase())&&(s=!0);break}return s}url(e,t,r=""){if(!e||!t)return!0;e=e.trim();const s=r||window.location.href,i=decodeURI(s);return[s,i].some(a=>this.doesMatch(t,e,a))}isEnabledSegment(e,t){if(t==="userTargeting")return this.settings.userTargeting.targetingType!=="segment"?!1:this.settings.userTargeting.enabledSegments[e]===!0}isVisibleOnUrl(){const e=this.settings.pageTargeting;if(e.targetingType==="all")return!0;if(e.targetingType==="homepage")return location.pathname==="/";if(e.targetingType==="selectedPages")return this.selectedPages();if(e.targetingType==="advanced"){let t=!0;return e!=null&&e.advancedTargets.length&&e.advancedTargets.filter(r=>r.matchText)&&(t=e.advancedTargets.some(r=>this.url(r.matchText,r.matchType))),e!=null&&e.excludedTargets.length&&(t=t&&!e.excludedTargets.filter(r=>r.matchText).some(r=>this.url(r.matchText,r.matchType))),t}}selectedPages(){var g,p;let e=!1,t=!1;const r=this.settings.pageTargeting;if(r.targetingType!=="selectedPages")return!0;const s=this.platform.getCurrentPageId();e=(((g=r.selectedPages)==null?void 0:g.map(f=>f.value.toString()))??[]).includes(s);const a=this.platform.getCurrentProductId();return t=(((p=r.selectedProducts)==null?void 0:p.map(f=>f.value.toString()))??[]).includes(a),e||t}isInApp(e){const t=["WebView","(iPhone|iPod|iPad)(?!.*Safari/)","Android.*(wv)"],r=new RegExp(`(${t.join("|")})`,"ig");return!!e.match(r)}evaluateReferrer(e){let t=!1;const r=u.getSession(d.ASKLAYER_REFERRER),s=u.getSession(d.ASKLAYER_SEARCH),i=navigator.userAgent;switch(e){case"in-app-browser":{t=this.isInApp(i);break}case"line-app-browser":case"line":t=i.includes("Line");break;case"yappli-app-browser":t=i.includes("Yappli");break;case"facebook":case"instagram":case"youtube":case"tiktok":case"reddit":case"pinterest":t=i.toLowerCase().includes(e)||(r==null?void 0:r.includes(e));break;case"twitter":t=i.toLowerCase().includes(e)||r.includes(e)||r.includes("t.co");break;case"google-ads":t=(s==null?void 0:s.includes("utm_source=google"))||(s==null?void 0:s.includes("gclid"));break;case"criteo-ads":t=s==null?void 0:s.includes("source=criteo");break;case"any-search-engine":t=["google","bing","yahoo","duckduckgo"].some(a=>r==null?void 0:r.includes(a));break}return t}device(){if(!this.isEnabledSegment("deviceType","userTargeting"))return!0;const e=this.settings.userTargeting.deviceType??"mobile";return e==="mobile"&&x()?!0:e==="desktop"&&!x()}recurrence(){var p;const e=this.survey.id,t=this.settings.recurrence.recurrenceType??"once",r=u.get(d.ASKLAYER_SURVEY_SHOWN)??[],s=u.getSession(d.ASKLAYER_SURVEY_SHOWN)??[],i=u.get(d.ASKLAYER_SURVEY_COMPLETED)??[],a=r.find(f=>f.id===e),l=s.find(f=>f.id===e),g=i.find(f=>f.id===e);return t==="once"?!a:t==="once_per_session"?!l&&!g:t==="every_time_not_completed"&&g&&(p=g.history)!=null&&p.length?g.history[g.history.length-1]>Date.now()-3*1e3:!0}lang(){var i,a,l;if(!this.isEnabledSegment("browserLanguage","userTargeting")||!((l=(a=(i=this.settings.userTargeting)==null?void 0:i.browserLanguage)==null?void 0:a.languages)!=null&&l.length))return!0;const e=window.navigator.language,t=this.settings.userTargeting.browserLanguage.languages,r=this.settings.userTargeting.browserLanguage.matchType??"equals",s=t.some(g=>{const p=g.value==="zh-CN"||g.value==="zh-TW"?5:2;return g.value===e.slice(0,p)});return r==="equals"&&s||r==="does_not_equal"&&!s}referrer(){var s,i,a;if(!this.isEnabledSegment("cameFrom","userTargeting")||!((a=(i=(s=this.settings.userTargeting)==null?void 0:s.cameFrom)==null?void 0:i.sources)!=null&&a.length))return!0;const e=this.settings.userTargeting.cameFrom.sources,t=this.settings.userTargeting.cameFrom.matchType??"equals",r=e.map(l=>l.value).some(this.evaluateReferrer.bind(this));return t==="equals"&&r||t==="does_not_equal"&&!r}frequency(){if(!this.isEnabledSegment("frequency","userTargeting"))return!0;const e=this.settings.userTargeting.frequency.interval??"any",t=this.settings.userTargeting.frequency.times??0,r=me(e);return t===0?r-1===t:r-1>=t}numberOfPageViewsInSession(){var s,i,a,l;if(!this.isEnabledSegment("numberOfPageViewsInSession","userTargeting"))return!0;const e=+u.getSession(d.ASKLAYER_NUMBER_OF_PAGEVIEWS_IN_SESSION),t=((i=(s=this.settings.userTargeting)==null?void 0:s.numberOfPageViewsInSession)==null?void 0:i.matchType)??"equals",r=+((l=(a=this.settings.userTargeting)==null?void 0:a.numberOfPageViewsInSession)==null?void 0:l.numberOfViews);return t==="more_than_equal"?e>=r:t==="less_than_equal"?e<=r:e===r}browsingHistory(){var e;return!this.isEnabledSegment("browsingHistory","userTargeting")||!((e=this.settings.userTargeting)!=null&&e.browsingHistory.length)?!0:this.settings.userTargeting.browsingHistory.some(t=>{const r=+t.numberOfTimes,s=t.matchText,i=t.matchType??"contains",l=(u.get(d.ASKLAYER_BROWSING_HISTORY)??[]).filter(p=>this.url(s,i,p[0]));return this.url(s,i)?l.length-1>=r:l.length>=r})}async geolocation(){var r,s,i,a;if(!this.isEnabledSegment("geolocation","userTargeting"))return!0;const e=((s=(r=this.settings.userTargeting)==null?void 0:r.geolocation)==null?void 0:s.countries.length)>0,t=((a=(i=this.settings.userTargeting)==null?void 0:i.geolocation)==null?void 0:a.states.length)>0;if(e||t){window.asklayerLocation?this.location=window.asklayerLocation:this.location=window.asklayerLocation=await ue();try{const l=this.location;return t?this.settings.userTargeting.geolocation.states.map(p=>p.value).includes(l.region):e?this.settings.userTargeting.geolocation.countries.map(p=>p.value).includes(l.country):!1}catch(l){return console.error(l),!0}}return!0}async userTags(){var a,l;if(!this.isEnabledSegment("userTags","userTargeting"))return!0;const e=((a=this.settings.userTargeting)==null?void 0:a.userTags)??{tags:[]},t=(l=e.tags)==null?void 0:l.map(g=>g.value);if(!t.length)return!0;const r=e.matchType??"equals",s=await this.platform.getUserTags(this.survey.userId);if(!s)return!1;const i=t.some(g=>s.includes(g));return r==="equals"?i:!i}blockIP(){var e,t,r;return!this.isEnabledSegment("blockIP","userTargeting")||!((r=(t=(e=this.settings.userTargeting)==null?void 0:e.blockIP)==null?void 0:t.ipAddresses)!=null&&r.length)?!0:!this.settings.userTargeting.blockIP.ipAddresses.map(s=>s.value).includes(this.location.ip)}async loginState(){var r;if(!this.isEnabledSegment("loginState","userTargeting"))return!0;const e=((r=this.settings.userTargeting)==null?void 0:r.loginState)??"is_logged_in",t=await this.platform.isLoggedIn();return e==="is_logged_in"&&t||e==="is_not_logged_in"&&t===!1}async productsOrdered(){var i;if(!this.isEnabledSegment("productPurchased","userTargeting"))return!0;const t=(((i=this.settings.userTargeting)==null?void 0:i.productPurchased)??[]).map(a=>String(a.value));if(!t.length)return!0;const r=await this.platform.getOrder(this.survey.userId);if(!r||!(r!=null&&r.line_items.length))return!1;const s=r.line_items.map(a=>String(a.product_id));return t.some(a=>s.includes(a))}async couponPoolRemains(){if(!Ee(this.survey))return!0;const e="https://asklayer-generic-api-6nonizu4oa-an.a.run.app/asklayer";try{const t=await fetch(`${e}/coupon-pool-check/${this.survey.id}`);return t.ok?(await t.json()).result:!1}catch{return!1}}}const Ie=async n=>{const{email:e,userId:t,orderId:r}=n;if(!e||!t)return;const s="https://asklayer-generic-api-6nonizu4oa-an.a.run.app/asklayer";try{if(!(await fetch(`${s}/sending-survey-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t,email:e,orderId:r})})).ok)throw new Error("Failed to send email")}catch(i){console.error(i)}};async function ve(){const n=document.querySelector("script[data-asklayer]");if(!n)throw new Error("Failed to find script element");let e=null;const t=_(),r=de(n,t);let s;if(r.type===h.LINK){if(ge(r.targetSurvey))return pe(),null;if([s,e]=await le(r),(s==null?void 0:s.length)===0||e)return he(),null}else{if([s,e]=await ce(r),e)throw new Error("Failed to fetch survey data");if(s.length===0)throw new Error("No surveys found")}const i=new Q;return s.forEach(a=>{new ae(a,new we(a,r),r).subscribe(i)}),i.init(),i}const Te=async()=>{var e,t,r,s;(t=(e=window.asklayerData)==null?void 0:e.triggerEmail)!=null&&t.email&&((s=(r=window.asklayerData)==null?void 0:r.triggerEmail)!=null&&s.userId)&&await Ie(window.asklayerData.triggerEmail);const n=await ve();be(n)};Te().catch(n=>{});function be(n){window.asklayer={triggerSurvey:e=>n.triggerSurvey(e),showStatus:e=>n.getStatus(e)}}
